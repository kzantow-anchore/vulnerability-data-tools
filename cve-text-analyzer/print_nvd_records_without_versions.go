package main

import (
	"fmt"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/cve"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/nvd"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/util"
	"io"
	"path"
)

func printRecordsWithoutVersions(filter string, writer io.Writer) {
	nvdRecords := map[string]nvd.Vulnerability{}
	for _, r := range nvd.ReadVulnerabilities(nvdDbFile, filter) {
		nvdRecords[cve.NormalizeCve(r.Cve.ID)] = r
	}

	fileGlob := path.Join(cveListDir, fmt.Sprintf("*/**/%s*.json", filter))
	cves := cve.ReadFiles(fileGlob)
	util.Log("CVEs without Versions:")
	_, _ = fmt.Fprintf(writer, "cve,state,published,updated\n")
	for _, c := range cves {
		// skip rejected records
		if c.Metadata.State == cve.StateRejected {
			continue
		}
		cveId := cve.NormalizeCve(c.Metadata.ID)
		vuln := nvdRecords[cveId]
		cpeMatches := allCpeMatches(vuln)
		if len(cpeMatches) == 0 {
			_, _ = fmt.Fprintf(writer, "%s,%s,%s,%s\n", c.Metadata.ID, c.Metadata.State, c.Metadata.Published, c.Metadata.Updated)
		} else {
			for _, m := range cpeMatches {
				if m.VersionStartExcluding != nil {
					util.Log("!!!!!!!!! VERSION START EXCLUDING:", vuln.Cve.ID, ": ", *m.VersionStartExcluding)
				}
			}
		}
	}
}

func getKnownCpeMatches(nvdDbFile string, filter string) map[string][]nvd.CpeMatch {
	out := map[string][]nvd.CpeMatch{}
	for _, vuln := range nvd.ReadVulnerabilities(nvdDbFile, filter) {
		cveId := cve.NormalizeCve(vuln.Cve.ID)
		ranges := out[cveId]
		ranges = append(ranges, allCpeMatches(vuln)...)
		if len(ranges) > 0 {
			out[cveId] = ranges
		}
	}

	return out
}

func allCpeMatches(vuln nvd.Vulnerability) []nvd.CpeMatch {
	var out []nvd.CpeMatch
	for _, conf := range vuln.Cve.Configurations {
		negate := false
		if conf.Negate != nil && *conf.Negate {
			negate = true
		}
		for _, node := range conf.Nodes {
			negateNode := negate
			if node.Negate != nil && *node.Negate {
				negateNode = !negateNode
			}
			for _, cpeMatch := range node.CpeMatch {
				if !cpeMatch.Vulnerable {
					continue
				}
				out = append(out, cpeMatch)
			}
		}
	}
	return out
}
