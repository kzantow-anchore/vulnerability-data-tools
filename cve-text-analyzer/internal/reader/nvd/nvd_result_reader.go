package nvd

import (
	"database/sql"
	"encoding/json"
	"strings"

	"github.com/facebookincubator/nvdtools/wfn"

	"github.com/anchore/grype-db/pkg/provider/unmarshal/nvd"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/cpe"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/reader/cve"
	"github.com/anchore/vulnerability-data-tools/cve-text-analyzer/internal/util"
)

type ResultRecordEnvelope struct {
	Item nvd.Vulnerability `json:"item"`
}

type (
	Vulnerability = nvd.Vulnerability
	CpeMatch      = nvd.CpeMatch
)

func ReadVulnerabilities(nvdDbFile, filter string) []Vulnerability {
	nvdDb := util.Get(sql.Open("sqlite", nvdDbFile))
	defer func() { util.Log(nvdDb.Close()) }()

	var args []any
	query := util.Get(nvdDb.Prepare("select record from results"))
	if filter != "" {
		query = util.Get(nvdDb.Prepare("select record from results where id like ?"))
		args = []any{"%" + strings.ToLower(filter) + "%"}
	}
	rows := util.Get(query.Query(args...))

	var out []Vulnerability
	for rows.Next() {
		var record string
		util.Log(rows.Scan(&record))
		var row ResultRecordEnvelope
		err := json.Unmarshal([]byte(record), &row)
		if err != nil {
			util.Log(err)
		} else {
			out = append(out, row.Item)
		}
	}
	return out
}

func GetKnownCveToSingleIDs(nvdDbFile string, filter string) (cveToID map[string][]string) {
	cveToID = map[string][]string{}

	for _, vuln := range ReadVulnerabilities(nvdDbFile, filter) {
		cveRecord := vuln.Cve
		cveId := cve.NormalizeCve(cveRecord.ID)

		id := extractSingleID(cveRecord)
		if id != "" {
			cveToID[cveId] = append(cveToID[cveId], id)
		}
	}

	return cveToID
}

func extractSingleID(cve nvd.CveItem) string {
	out := ""
	for _, conf := range cve.Configurations {
		for _, node := range conf.Nodes {
			for _, cpeMatch := range node.CpeMatch {
				w, err := wfn.Parse(cpeMatch.Criteria)
				if err == nil && w != nil {
					if out == "" {
						out = cpe.ToID(w)
					} else {
						if out != cpe.ToID(w) {
							return ""
						}
					}
				}
			}
		}
	}
	return out
}
